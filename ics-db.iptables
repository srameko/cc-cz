#!/bin/bash

IPTABLES=/sbin/iptables
IP6TABLES=/sbin/ip6tables

# objects/machines
GL_DNS=10.7.1.3
DMZ=10.0.1.0/29
FW_DMZ=10.0.1.2
FW_DSK=10.0.2.2
FW_SRV=10.0.3.2
FW_ICS=10.0.4.2
FW_UP=192.168.6.2
DMZ_WEB=10.0.1.3
DMZ_MAIL=10.0.1.4
DMZ_DNS=10.0.1.5
DMZ_SUP=10.0.1.6
DSK=10.0.2.0/28
DSK_A1=10.0.2.3
DSK_A2=10.0.2.4
DSK_A3=10.0.2.5
DSK_U1=10.0.2.6
DSK_U2=10.0.2.7
DSK_U3=10.0.2.8
SRV=10.0.3.0/28
SRV_DB=10.0.3.3
SRV_WB=10.0.3.4
SRV_FL=10.0.3.5
SRV_AD=10.0.3.9
ICS=10.0.4.0/29
ICS_DB=10.0.4.3
ICS_WS=10.0.4.4
ICS_HS=10.0.4.5

# Flush
echo " Flushing existing rules "
$IPTABLES -F
$IPTABLES -X
$IPTABLES -t nat -F
$IPTABLES -t nat -X
$IPTABLES -t mangle -F
$IPTABLES -t mangle -X

$IP6TABLES -F
$IP6TABLES -X
$IP6TABLES -t nat -F
$IP6TABLES -t nat -X
$IP6TABLES -t mangle -F
$IP6TABLES -t mangle -X

# DROP Red Team IPs
#$IPTABLES -t mangle -A PREROUTING -s X.X.X.X -j DROP

# Allow related, established conn
echo " ALLOW related, established connection "
$IPTABLES -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
$IPTABLES -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# KILL all traffic
$IPTABLES -P INPUT DROP
$IPTABLES -P FORWARD DROP
$IPTABLES -P OUTPUT DROP

$IP6TABLES -P INPUT DROP
$IP6TABLES -P FORWARD DROP
$IP6TABLES -P OUTPUT DROP

# kypo management
$IPTABLES -A INPUT -d 172.16.0.0/16 -j ACCEPT
$IPTABLES -A OUTPUT -s 172.16.0.0/16 -j ACCEPT

# ALLOW icmp
$IPTABLES -A INPUT -p icmp --icmp-type echo-request -s $ICS_DB -d $ICS_DB -j ACCEPT
$IPTABLES -A OUTPUT -p icmp --icmp-type echo-reply -s $ICS_DB -d $SRV -j ACCEPT

# TO DO ACCEPT GT db access : ICS check ; ADD GT interface
$IPTABLES -A INPUT -p TCP --dport 5432 -d $ICS_DB_GT -m state NEW,ESTABLISHED,RELATED -j ACCEPT

# TO DO ACCEPT BT db access from ICS WS
$IPTABLES -A INPUT -p TCP --dport 5432 -d $ICS_DB -s $ICS_WS -m state NEW,ESTABLISHED,RELATED -j ACCEPT

# TO DO ACCESS BT (management from ws, only admin?) ; ADD WS IPs
$IPTABLES -A INPUT -p TCP --dport 22 -d 10.0.4.3 -s $DSK -m state NEW -j ACCEPT
$IPTABLES -A INPUT -p TCP -m multiport --dports 80,443 -d 10.0.4.3 -s $DSK -m state NEW -j ACCEPT

$IPTABLES -A INPUT -p TCP --dport 22 -m --state ESTABLISHED,RELATED -j ACCEPT
$IPTABLES -A OUTPUT -p TCP --sport 22 -m --state ESTABLISHED,RELATED -j ACCEPT
$IPTABLES -A INPUT -p TCP -m multiport --dports 80,443 -m --state ESTABLISHED,RELATED -j ACCEPT
$IPTABLES -A OUTPUT -p TCP -m multiport --sports 80,443 -m --state ESTABLISHED,RELATED -j ACCEPT

# SET DEFAULT iptables POLICY
$IPTABLES -P INPUT -j DROP
$IPTABLES -P FORWARD -j DROP
$IPTABLES -P OUTPUT -j DROP

# SAVE
echo " Saving iptables "
iptables-save > /etc/firewall.rules -j ACCEPT

echo " Let's have fun with Red Team "
