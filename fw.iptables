#!/bin/bash

# Flush
--flush
--table nat --flush
--delete-chain
--delete-chain

# TO DO DELETE iptables -t nat PREROUTING !!!

# Allow related, established conn
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# FW Allow
-A INPUT -i lo -j ACCEPT
# HTTP on FW?
-A INPUT -p TCP --dport 80 -d 10.X.1.2 -m conntrack --ctstate NEW -j ACCEPT
-A INPUT -p TCP --dport 443 -d 10.X.1.2 -m conntrack --ctstate NEW -j ACCEPT
# ssh
-A INPUT -p TCP --dport 22 -d 10.X.1.2  -m conntrack --ctstate NEW -j ACCEPT
-A OUTPUT -p TCP -s 10.X.1.2 --sport 22 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
# ntop
-A INPUT -p TCP --dport 3000 -d 10.X.1.2 -s 10.0.2.X -m conntrack --ctstate NEW -j ACCEPT
# icmp 
-A INPUT -p ICMP --icmp-type echo-request -d 10.X.1.2 -j ACCEPT
-A OUTPUT -p ICMP --icmp-type echo-reply -s 10.X.1.2 -j ACCEPT

# TO DO ???
-A INPUT -p TCP -d 10.X.1.2 --dport 5001 -m conntrack --ctstate NEW -j ACCEPT
-A FORWARD -i eth3 -o eth2 -p TCP -s 10.0.4.0/24 -d 10.0.3.0/24 --dport 443  -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth3 -p TCP -s 10.0.3.0/24 -d 10.0.4.0/24 --sport 443  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 

# INTERNET
-A INPUT -p TCP -d 10.0.1.0/24 -j ACCEPT
-A INPUT -p TCP -d 10.0.2.0/24 -j ACCEPT
-A INPUT -p TCP -d 10.0.3.0/24 -j ACCEPT
-A INPUT -p TCP -d 10.0.4.0/24 -j ACCEPT

# TO DO intra segment FW! (srv-srv,desktop-desktop,ics-ics,...)

# GLOBAL > DMZ
# dmz-web
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.3 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 80 -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.3 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 443 -j ACCEPT
# dmz-mail
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.4 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 993 -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.4 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 3306 -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.4 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 443 -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.4 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 80 -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.4 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 110 -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.4 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 143 -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.4 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 995 -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.4 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 25 -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.4 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 587 -j ACCEPT
# dmz-dns
-A FORWARD -i eth4 -o eth0  -p TCP -d 10.0.1.5 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 53 -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p UDP -d 10.0.1.5 --dport 53 -j ACCEPT
# dmz-support
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.6 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 80 -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.6 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 443 -j ACCEPT
# icmp-to-dmz
-A FORWARD -i eth4 -o eth0 -p ICMP --icmp-type echo-request -d 10.0.1.0/24 -j ACCEPT
-A FORWARD -i eth0 -o eth4 -p ICMP --icmp-type echo-reply -s 10.0.1.0/24 -j ACCEPT
# TO DO ???
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.0/24 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 21 -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p TCP -d 10.0.1.0/24 -m conntrack --ctstate ESTABLISHED,RELATED --dport 20 -j ACCEPT
-A FORWARD -i eth0 -o eth4 -p TCP -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p TCP -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth0 -o eth4 -p UDP -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p UDP -j ACCEPT
-A FORWARD -i eth0 -o eth4 -p ICMP -j ACCEPT
-A FORWARD -i eth4 -o eth0 -p ICMP -j ACCEPT

# dmz-support > srv-?? ; CHECK if it is correct!
-A FORWARD -i eth0 -o eth2 -p TCP -s 10.0.1.6 -d 10.0.3.0/24 --dport 1433 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth2 -o eth0 -p TCP -s 10.0.3.0/24 -d 10.0.1.6 --sport 1433 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth0 -o eth2 -p TCP -s 10.0.1.6 -d 10.0.3.0/24 --dport 5432 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth0 -p TCP -s 10.0.3.0/24 -d 10.0.1.6 --sport 5432 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth0 -o eth2 -p TCP -s 10.0.1.6 -d 10.0.3.0/24 --dport 389 -m conntrack --ctstate  NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth0 -p TCP -s 10.0.3.0/24 -d 10.0.1.0/24 --sport 389 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth0 -o eth2 -p TCP -s 10.0.1.6 -d 10.0.3.0/24 --dport 3306 -m conntrack --ctstate  NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth0 -p TCP -s 10.0.3.0/24 -d 10.0.1.6 --sport 3306 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth0 -o eth2 -p UDP -s 10.0.1.0/24 -d 10.0.3.0/24 --dport 389 -j ACCEPT 
-A FORWARD -i eth2 -o eth0 -p UDP -s 10.0.3.0/24 -d 10.0.1.0/24 --sport 389 -j ACCEPT 
-A FORWARD -i eth0 -o eth2 -p UDP -s 10.0.1.0/24 -d 10.0.3.0/24 --dport 123 -j ACCEPT 
-A FORWARD -i eth2 -o eth0 -p UDP -s 10.0.3.0/24 -d 10.0.1.0/24 --sport 123 -j ACCEPT 

# DESKTOP > SRV 
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 3389 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 3389 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 5900 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 5900 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 135 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 135 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 139 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 139 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 3268 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 3268 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 3269 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 3269 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 389 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 389 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth1 -o eth2 -p UDP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 389 -j ACCEPT
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 88 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 88 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 464 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 464 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth2 -p UDP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 464 -j ACCEPT
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 80 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 80 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 443 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 443 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 445 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 445 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 22 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 22 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 53 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 53 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth1 -o eth2 -p UDP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 53 -j ACCEPT
-A FORWARD -i eth2 -o eth1 -p UDP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 53 -j ACCEPT
-A FORWARD -i eth1 -o eth2 -p UDP -s 10.0.2.0/24 -d 10.0.3.0/24 --dport 123 -j ACCEPT
-A FORWARD -i eth2 -o eth1 -p UDP -s 10.0.3.0/24 -d 10.0.2.0/24 --sport 123 -j ACCEPT
-A FORWARD -i eth1 -o eth2 -p ICMP --icmp-type echo-request -s 10.0.2.0/24 -d 10.0.3.0/24 -j ACCEPT 
-A FORWARD -i eth2 -o eth1 -p ICMP --icmp-type echo-reply -s 10.0.3.0/24 -d 10.0.2.0/24 -j ACCEPT
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --dport 21 -j ACCEPT
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 -m conntrack --ctstate ESTABLISHED,RELATED --sport 21 -j ACCEPT
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 -m conntrack --ctstate NEW,ESTABLISHED,RELATED --sport 20 -j ACCEPT
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 -m conntrack --ctstate ESTABLISHED,RELATED --dport 20 -j ACCEPT

# DESKTOP > DMZ
-A FORWARD -i eth1 -o eth0 -p TCP -s 10.0.2.0/24 -d 10.0.1.0/24 --dport 3389 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth0 -o eth1 -p TCP -s 10.0.1.0/24 -d 10.0.2.0/24 --sport 3389 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth1 -o eth0 -p TCP -s 10.0.2.0/24 -d 10.0.1.0/24 --dport 80 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth0 -o eth1 -p TCP -s 10.0.1.0/24 -d 10.0.2.0/24 --sport 80 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth0 -p TCP -s 10.0.2.0/24 -d 10.0.1.0/24 --dport 443 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth0 -o eth1 -p TCP -s 10.0.1.0/24 -d 10.0.2.0/24 --sport 443 -m conntrack --ctstate  ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth0 -p TCP -s 10.0.2.0/24 -d 10.0.1.0/24 --dport 22 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth0 -o eth1 -p TCP -s 10.0.1.0/24 -d 10.0.2.0/24 --sport 22 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth0 -p TCP -s 10.0.2.0/24 -d 10.0.1.0/24 --dport 110 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth0 -o eth1 -p TCP -s 10.0.1.0/24 -d 10.0.2.0/24 --sport 110 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth0 -p TCP -s 10.0.2.0/24 -d 10.0.1.0/24 --dport 143 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth0 -o eth1 -p TCP -s 10.0.1.0/24 -d 10.0.2.0/24 --sport 143 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth0 -p TCP -s 10.0.2.0/24 -d 10.0.1.0/24 --dport 995 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth0 -o eth1 -p TCP -s 10.0.1.0/24 -d 10.0.2.0/24 --sport 995 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth0 -p TCP -s 10.0.2.0/24 -d 10.0.1.0/24 --dport 993 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth0 -o eth1 -p TCP -s 10.0.1.0/24 -d 10.0.2.0/24 --sport 993 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth0 -p ICMP --icmp-type echo-request -s 10.0.2.0/24 -d 10.0.1.0/24  -j ACCEPT 
-A FORWARD -i eth1 -o eth0 -p ICMP --icmp-type echo-reply -s 10.0.2.0/24 -d 10.0.1.0/24  -j ACCEPT
-A FORWARD -i eth1 -o eth0 -p TCP -s 10.0.2.0/24 -d 10.0.1.5 --dport 53 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth0 -o eth1 -p TCP -s 10.0.1.5 -d 10.0.2.0/24 --sport 53 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth0 -p UDP -s 10.0.2.0/24 -d 10.0.1.5 --dport 53 -j ACCEPT
-A FORWARD -i eth0 -o eth1 -p UDP -s 10.0.1.5 -d 10.0.2.0/24 --sport 53 -j ACCEPT
-A FORWARD -i eth1 -o eth0 -p TCP -s 10.0.2.0/24 -d 10.0.1.0/24 --dport 25 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth0 -o eth1 -p TCP -s 10.0.1.0/24 -d 10.0.2.0/24 --sport 25 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth0 -p TCP -s 10.0.2.0/24 -d 10.0.1.0/24 --dport 587 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth0 -o eth1 -p TCP -s 10.0.1.0/24 -d 10.0.2.0/24 --sport 587 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# DESKTOP -> ICS 
-A FORWARD -i eth1 -o eth3 -p TCP -s 10.0.2.0/24 -d 10.0.4.0/24 --dport 3389 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth3 -o eth1 -p TCP -s 10.0.4.0/24 -d 10.0.2.0/24 --sport 3389 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth3 -p TCP -s 10.0.2.0/24 -d 10.0.4.0/24 --dport 22 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth3 -o eth1 -p TCP -s 10.0.4.0/24 -d 10.0.2.0/24 --sport 22  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth3 -p icmp --icmp-type echo-request  -s 10.0.2.0/24 -d 10.0.4.0/24 -j ACCEPT
-A FORWARD -i eth3 -o eth1 -p icmp --icmp-type echo-reply  -s 10.0.4.0/24 -d 10.0.2.0/24 -j ACCEPT

# DESKTOP > Global net
-A FORWARD -i eth1 -o eth4 -p TCP -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth4 -o eth1 -p TCP -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth1 -o eth4 -p UDP -j ACCEPT
-A FORWARD -i eth4 -o eth1 -p UDP -j ACCEPT
-A FORWARD -i eth1 -o eth4 -p ICMP -j ACCEPT
-A FORWARD -i eth4 -o eth1 -p ICMP -j ACCEPT

# SRV > DESKTOP
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --dport 3389 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --sport 3389 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth1 -p TCP -s 10.0.3.0/24 -d 10.0.2.0/24 --dport 5900 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth1 -o eth2 -p TCP -s 10.0.2.0/24 -d 10.0.3.0/24 --sport 5900 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth1 -p icmp --icmp-type echo-request -s 10.0.3.0/24 -d 10.0.2.0/24 -j ACCEPT
-A FORWARD -i eth1 -o eth2 -p icmp --icmp-type echo-reply -s 10.0.2.0/24 -d 10.0.3.0/24 -j ACCEPT

# SRV > DMZ 
-A FORWARD -i eth2 -o eth0 -p TCP -s 10.0.3.0/24 -d 10.0.1.5 --dport 53 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth0 -o eth2 -p TCP -s 10.0.1.5 -d 10.0.3.0/24 --sport 53 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth0 -p UDP -s 10.0.3.0/24 -d 10.0.1.5 --dport 53 -j ACCEPT 
-A FORWARD -i eth0 -o eth2 -p UDP -s 10.0.1.5 -d 10.0.3.0/24 --sport 53 -j ACCEPT 
-A FORWARD -i eth2 -o eth0 -p icmp --icmp-type echo-request -s 10.0.3.0/24 -d 10.0.1.0/24 -j ACCEPT
-A FORWARD -i eth0 -o eth2 -p icmp --icmp-type echo-reply -s 10.0.1.0/24 -d 10.0.3.0/24 -j ACCEPT

# SRV > ICS
-A FORWARD -i eth2 -o eth3 -p icmp --icmp-type echo-request -s 10.0.3.0/24 -d 10.0.4.0/24 -j ACCEPT
-A FORWARD -i eth3 -o eth2 -p icmp --icmp-type echo-reply -s 10.0.4.0/24 -d 10.0.3.0/24 -j ACCEPT

# SRV > Global net
-A FORWARD -i eth2 -o eth4 -p TCP -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth4 -o eth2 -p TCP -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth2 -o eth4 -p UDP -j ACCEPT
-A FORWARD -i eth2 -o eth4 -p ICMP -j ACCEPT

#ICS > SRV
-A FORWARD -i eth3 -o eth2 -p TCP -s 10.0.4.0/24 -d 10.0.3.0/24 --dport 445 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth3 -p TCP -s 10.0.3.0/24 -d 10.0.4.0/24 --sport 445 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth3 -o eth2 -p TCP -s 10.0.4.0/24 -d 10.0.3.0/24 --dport 53 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth3 -p TCP -s 10.0.3.0/24 -d 10.0.4.0/24 --sport 53 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth3 -o eth2 -p UDP -s 10.0.4.0/24 -d 10.0.3.0/24 --dport 53 -j ACCEPT 
-A FORWARD -i eth2 -o eth3 -p UDP -s 10.0.3.0/24 -d 10.0.4.0/24 --sport 53 -j ACCEPT 
-A FORWARD -i eth3 -o eth2 -p UDP -s 10.0.4.0/24 -d 10.0.3.0/24 --dport 123 -j ACCEPT 
-A FORWARD -i eth2 -o eth3 -p UDP -s 10.0.3.0/24 -d 10.0.4.0/24 --sport 123 -j ACCEPT 
-A FORWARD -i eth3 -o eth2 -p TCP -s 10.0.4.0/24 -d 10.0.3.0/24 --dport 80 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth3 -p TCP -s 10.0.3.0/24 -d 10.0.4.0/24 --sport 80 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth3 -o eth2 -p TCP -s 10.0.4.0/24 -d 10.0.3.0/24 --dport 443 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT 
-A FORWARD -i eth2 -o eth3 -p TCP -s 10.0.3.0/24 -d 10.0.4.0/24 --sport 443 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

#ICS > DMZ
-A FORWARD -i eth3 -o eth0 -p TCP -s 10.0.4.0/24 -d 10.0.1.5 --dport 53 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth0 -o eth3 -p TCP -s 10.0.1.5 -d 10.0.4.0/24 --sport 53 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i eth3 -o eth0 -p UDP -s 10.0.4.0/24 -d 10.0.1.5 --dport 53 -j ACCEPT
-A FORWARD -i eth0 -o eth3 -p UDP -s 10.0.1.5 -d 10.0.4.0/24 --sport 53 -j ACCEPT

# OUTPUT
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT -p icmp -j ACCEPT
# TO DO ???
-A OUTPUT -p tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT

# DROP rest
-A INPUT -j DROP
-A FORWARD -j DROP
-A OUTPUT -j DROP

# SAVE
iptables-save > /etc/firewall.rules -j ACCEPT
